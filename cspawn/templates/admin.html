{% extends "page.html" %}

{% block title %}Admin Dashboard - League Code Server{% endblock %}

{% block styles %}
<style>
    /* Override container width for admin page */
    .container {
        min-width: 600px !important;
        max-width: 1200px !important;
        width: auto !important;
        padding-left: 1rem !important;
        padding-right: 1rem !important;
    }

    /* Ensure table remains readable on smaller screens */
    @media (max-width: 800px) {
        .small-text {
            font-size: 0.7rem;
        }
    }
</style>
{% endblock %}

{% block header %}
<div class="text-center">
    <h1 class="mb-4">League Code Server - Admin Dashboard</h1>
</div>
{% endblock %}

{% block content %}
<!-- Action Buttons -->
<div class="row mb-4">
    <div class="col">
        <a href="{{ url_for('start_server') }}" class="btn btn-success float-start">Start Server</a>
        <a href="{{ url_for('auth.jtl_auth_logout') }}" class="btn btn-primary float-end">Logout</a>

        {% if server_status == 'running' %}
        <a href="{{ url_for('stop_server') }}" class="btn btn-danger float-end me-2">Stop Server</a>
        {% endif %}
        
    </div>
</div>

<!-- User Info -->
<div class="card mb-4">
    <div class="card-body">
        <p class="mb-2">Logged in as: {{ current_user.primary_email }} ({{current_user.role}})</p>
        <p class="mb-0">Server Name: {{server_hostname}} ({{server_status}})</p>
    </div>
</div>

<!-- Containers Table -->
<div class="card">
    <div class="card-body">
        <h2 class="card-title mb-4">Containers</h2>
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-light">
                    <tr>
                        <th>Username</th>
                        <th>Password</th>
                        <th>Status</th>
                        <th>Login</th>
                    </tr>
                </thead>
                <tbody>
                    {% for (container, status) in containers %}
                    <tr>
                        <td>
                            <a href="https://{{ container.labels['caddy'] }}" 
                               target="_blank"
                               class="text-decoration-none">
                                {{ container.labels['jtl.codeserver.username'] }}
                            </a>
                        </td>
                        <td>{{ container.labels['jt.codeserver.password'] }}</td>
                        <td>
                            <div class="small text-muted">
                                {{container.status}}<br/>
                                ‚ù§Ô∏è{{status.heartbeatAgo}} üóùÔ∏è{{status.seconds_since_report}}<br/>
                                Mem: {{(status.memory_usage/(1024*1024))|int}} MB<br/>                              
                                {% if status.port and container.status == 'running' %}                                    
                                    <a href="http://localhost:{{ status.port }}" target="_blank">http://localhost:{{ status.port }}</a>
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            {% if container.status == 'running' %}
                            <form action="https://{{ container.labels['caddy'] }}/login" 
                                  method="POST" 
                                  target="_blank">
                                <input type="hidden" name="base" value=".">
                                <input type="hidden" name="href" value="https://{{ container.labels['caddy'] }}">
                                <input type="hidden" name="password" value="{{ container.labels['jt.codeserver.password'] }}">
                                <button type="submit" class="btn btn-primary btn-sm">Login</button>
                            </form>

                            <a href="{{ url_for('stop_server', server_id=container.id) }}" class="btn btn-danger btn-sm mt-2">Stop Server</a>
                            {% endif %}
                
                            
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{% endblock %}